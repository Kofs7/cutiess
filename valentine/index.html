<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Great Connection: Finale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        :root {
            --ink: #2b2b2b;
            --paper: #fdf5e6;
            --baby-blue: #A2D2FF;
            --heart-red: #d62828;
        }

        body { 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: #111; 
            overflow: hidden; 
            font-family: 'Courier New', monospace;
        }

        /* Perspective wrapper for the zoom-out effect */
        #viewport {
            perspective: 1200px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        #stage {
            width: 1000px; 
            height: 562px; 
            position: relative;
            background: url('images/back.jpeg') no-repeat center center;
            background-size: cover; 
            border: 12px solid var(--ink);
            border-radius: 10px; 
            box-shadow: 0 30px 90px rgba(0,0,0,0.9);
            overflow: hidden;
            background-color: #333; /* Fallback */
        }

        /* Characters & Gifts */
        .char { position: absolute; width: 180px; bottom: 80px; z-index: 10; }
        #cuphead { left: 8%; } 
        #chalice { right: 8%; }
        
        .gift { 
            position: absolute; 
            display: none; 
            z-index: 15; 
            bottom: 180px; 
            mix-blend-mode: multiply; 
        }
        #flower { width: 80px; left: 18%; }
        #bouquet { width: 220px; left: 18%; }

        /* The Finale Image - Phases in at the end */
        #finale-pic {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            object-fit: cover; 
            opacity: 0; 
            z-index: 150; /* Sits above characters but below THE END card */
            pointer-events: none;
        }

        /* UI Panel */
        #ui-container {
            position: absolute; 
            bottom: 40px; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 15px; 
            z-index: 250; /* Highest priority to stay visible if needed */
        }
        
        .text-box {
            background: var(--paper); 
            border: 3px solid var(--ink);
            padding: 10px 30px; 
            border-radius: 12px; 
            font-weight: 900; 
            color: #1e6091; 
            box-shadow: 4px 4px 0px var(--ink);
            transition: all 0.3s ease;
        }
        
        .button-row { display: flex; gap: 15px; }
        
        button {
            padding: 10px 25px; 
            border: 3px solid var(--ink); 
            background: #fff;
            font-weight: 900; 
            cursor: pointer; 
            border-radius: 12px;
            box-shadow: 4px 4px 0 var(--ink);
            font-family: inherit;
        }
        
        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--ink);
        }

        /* THE FINALE OVERLAY (The End Card) */
        #finale-card {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center;
            opacity: 0; 
            pointer-events: none; 
            z-index: 200;
        }
        
        .the-end {
            background: #fdf5e6; 
            border: 8px solid var(--ink);
            padding: 20px 60px; 
            font-size: 5rem; 
            font-weight: 900;
            color: var(--baby-blue); 
            text-shadow: 5px 5px 0 var(--ink);
            box-shadow: 15px 15px 0 rgba(0,0,0,0.3);
            transform: rotate(-3deg);
        }
    </style>
</head>
<body>

<div id="viewport">
    <div id="stage">
        <img id="cuphead" src="images/cuphead.webp" alt="Cuphead" class="char">
        <img id="chalice" src="images/mschalice.webp" alt="Ms. Chalice" class="char">

        <img id="flower" src="images/flower.png" alt="Flower" class="gift">
        <img id="bouquet" src="images/flowers.png" alt="Bouquet" class="gift">
        
        <img id="finale-pic" src="images/cuphead&chalice.webp" alt="Valentine Finale">

        <div id="ui-container">
            <div class="text-box" id="status-box">VocÃª quer ser meu Namorado??</div>
            <div class="button-row" id="btns">
                <button onclick="deliver('single')">Sim</button>
                <button onclick="deliver('bouquet')" style="background: var(--baby-blue);">Sim De Novo</button>
            </div>
        </div>

        <div id="finale-card">
            <div class="the-end">MELHOR ESCOLHA!</div>
        </div>
    </div>
</div>

<script>
    // Audio Context Setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(fStart, fEnd, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); 
        gain.connect(audioCtx.destination);
        
        osc.frequency.setValueAtTime(fStart, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(fEnd, audioCtx.currentTime + duration);
        
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        
        osc.start(); 
        osc.stop(audioCtx.currentTime + duration);
    }

    // Constant idle "bounce" for characters
    gsap.to(".char", { 
        y: -18, 
        duration: 0.45, 
        repeat: -1, 
        yoyo: true, 
        ease: "sine.inOut" 
    });

    function deliver(type) {
        // Resume audio on user interaction
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const boy = document.getElementById('cuphead');
        const flower = document.getElementById('flower');
        const bouquet = document.getElementById('bouquet');
        const status = document.getElementById('status-box');

        // Hide buttons
        gsap.to("#btns", { opacity: 0, pointerEvents: "none", duration: 0.5 });

        const isBouquet = type === 'bouquet';
        const duration = isBouquet ? 7 : 4;
        
        // Show selected gift
        if(isBouquet) bouquet.style.display = "block"; 
        else flower.style.display = "block";
        
        status.innerText = isBouquet ? "Growing Affection..." : "Processing...";
        
        playSound(400, 800, duration);

        // Character walks across the stage
        gsap.to([boy, isBouquet ? bouquet : flower], { 
            x: 560, 
            duration: duration, 
            ease: "slow(0.7, 0.7, false)",
            onComplete: () => {
                playSound(880, 880, 0.5); // "Ding!" success sound
                status.innerText = "YO â¤ï¸ LU: Connected!";
                status.style.color = "var(--heart-red)";
                
                // Trigger the cinematic finale
                setTimeout(runFinale, 1500);
            }
        });
        
        if(isBouquet) {
            gsap.to(bouquet, { scale: 1.3, duration: duration });
            setTimeout(rainHearts, 1000);
        }
    }

    function runFinale() {
        const finalePic = document.getElementById('finale-pic');
        const statusBox = document.getElementById('status-box');

        // 1. Phase in the finale image (The heart-warming picture)
        gsap.to(finalePic, { 
            opacity: 1, 
            duration: 2.5, 
            ease: "power1.inOut" 
        });

        // 2. Zoom out and tilt the stage like a closing cartoon
        gsap.to("#stage", { 
            scale: 0.65, 
            rotation: 3,
            duration: 3, 
            ease: "power2.inOut" 
        });

        // 3. Bring in "THE END" card
        gsap.to("#finale-card", { 
            opacity: 1, 
            duration: 2, 
            delay: 1.5,
            onStart: () => {
                // Update final message and bring to front
                statusBox.innerText = "Happy Valentine's Day!";
                statusBox.style.background = "var(--baby-blue)";
                statusBox.style.color = "white";
                document.getElementById('ui-container').style.zIndex = "300";
            }
        });
    }

    function rainHearts() {
        const stage = document.getElementById('stage');
        for(let i=0; i<35; i++) {
            const h = document.createElement('div');
            h.innerHTML = "ðŸ’™"; 
            h.style.position = "absolute";
            h.style.left = Math.random() * 100 + "%"; 
            h.style.top = "-50px";
            h.style.fontSize = (1.5 + Math.random() * 2) + "rem";
            h.style.zIndex = "20";
            stage.appendChild(h);

            gsap.to(h, { 
                y: 650, 
                x: "+=" + (Math.random() * 200 - 100), 
                rotation: 720, 
                duration: 3 + Math.random() * 3, 
                opacity: 0, 
                delay: Math.random() * 2, 
                onComplete: () => h.remove() 
            });
        }
    }
</script>
</body>
</html>